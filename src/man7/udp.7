.\" This man page is Copyright (C) 1999 Andi Kleen <ak@muc.de>.
.\" Permission is granted to distribute possibly modified copies
.\" of this page provided the header is included verbatim,
.\" and in case of nontrivial modification author and date
.\" of the modification is added to the header.
.\" $Id: udp.7,v 1.4 2001/05/26 23:45:00 alexm Exp $
.\" Вычитано и скорректировано by alexm@hsys.msk.ru для проекта
.\" http://alexm.here.ru/manpages-ru/
.TH UDP  7 "2 окт 1998" "Страницы Руководства по Linux" "Руководство программиста Linux" 
.SH НАЗВАНИЕ
udp \- протокол UDP (User Datagram Protocol) поверх протокола IPv4.
.SH ОБЗОР
.B #include <sys/socket.h>
.br
.B #include <netinet/in.h>
.br
.B udp_socket = socket(PF_INET, SOCK_DGRAM, 0); 

.SH ОПИСАНИЕ
Это реализация User Datagram Protocol (Протокола Пользовательских
Датаграмм, UDP), который описан в RFC768. 
Он обеспечивает ненадежную передачу датаграмм без установления соединения.
При пересылке пакеты могут дублироваться, а их порядок может быть нарушен.  UDP
генерирует и проверяет контрольные суммы, чтобы отловить ошибки передачи.

При создании UDP-сокета его локальный и удаленный адрес не указываются.
Датаграммы могут быть посланы немедленно с помощью 
.BR sendto (2)
или
.BR sendmsg (2),
с правильным адресом назначения в качестве аргумента.
Когда для сокета вызывается 
.BR connect (2), 
то устанавливается адрес назначения по умолчанию и с этого момента датаграммы 
могут отсылаться с помощью 
.BR send (2)
или 
.BR write (2),
без указания адреса назначения.
При этом все еще сохраняется возможность послать пакет другому адресату,
передавая его адрес процедурам
.BR sendto (2)
или 
.BR sendmsg (2).
Для получения пакетов сокет сначала можно привязать к локальному адресу
с помощью
.BR bind (2).
В противном случае сокетный уровень автоматически присвоит свободный
локальный порт из диапазона, заданного в
.IR net.ipv4.ip_local_port_range ,
и привяжет сокет к
.BR INADDR_ANY .

Все операции приема возвращают только один пакет.  Если пакет меньше, чем 
размер буфера приема, то он возвращается целиком; если пакет больше, 
то он обрезается и устанавливается флаг 
.BR MSG_TRUNC .
.I MSG_WAITALL
не поддерживается.

Опции IP могут быть посланы или получены при помощи опций сокета, описанных в 
.BR ip (7).
Они обрабатываются ядром, если включено соответствующее sysctl-значение
(но даже если оно отключено, опции все равно передаются пользователю). Смотри 
.BR ip (7).

Если при отсылке установлен флаг 
.BR MSG_DONTROUTE ,
то адрес назначения должен указывать на адрес локального интерфейса,
и пакеты посылаются только на этот интерфейс.  

UDP фрагментирует пакет, если его общий размер превышает значение MTU 
(Maximum Transmission Unit) интерфейса. 
Более дружелюбной для сети альтернативой является использование метода
обнаружения MTU маршрута,
который описан в разделе 
.B IP_PMTU_DISCOVER 
страницы руководства 
.BR ip (7).

.SH ФОРМАТ АДРЕСА
UDP использует формат адреса IPv4 
.BR sockaddr_in ,
который описан в 
.BR ip (7). 

.SH ОБРАБОТКА ОШИБОК
Все фатальные ошибки будут передаваться пользователю в виде 
кода ошибки, который возвращается, даже если сокет не соединен. 
Это относится также и к асинхронным ошибкам, полученным из сети.  Вы
можете получить ошибку, относящуюся к более раннему пакету, посланному
на том же сокете.
Такое поведение отличается от поведения
многих других реализаций BSD-сокетов, которые никогда не передают коды ошибок,
если на сокете не установлено соединение.  Поведение Linux в этом
случае соответствует
.BR RFC1122 .

Для совместимости со старым кодом можно установить опцию SOL_SOCKET 
.BR SO_BSDCOMPAT ,
чтобы получать удаленные ошибки, только если сокет был соединен (кроме ошибок 
.B EPROTO
и 
.BR EMSGSIZE ).
Однако лучше исправить код, чтобы он правильно обрабатывал ошибки,
чем использовать эту опцию. 
Ошибки, возникшие локально, передаются всегда.

Если включена опция 
.BR IP_RECVERR , 
то все ошибки хранятся в очереди ошибок сокета 
и могут быть получены с помощью функции 
.BR recvmsg (2)
с установленным флагом 
.BR MSG_ERRQUEUE . 

.SH IOCTL
К нижеперечисленным ioctl можно обратиться с помощью
.BR ioctl (2).
Правильный синтаксис таков:
.PP
.RS
.nf
.BI int " value";
.IB error " = ioctl(" tcp_socket ", " ioctl_type ", &" value ");"
.fi
.RE
.TP
.B SIOCINQ
В качестве параметра получает указатель на целое число.  Возвращает
размер следующей ожидающей датаграммы в байтах, помещая их в это целое
число, или же 0, если нет ожидающей датаграммы.
.TP
.B SIOCOUTQ
Возвращает количество байт данных в локальной очереди отправки.
Поддерживается только в Linux 2.4 и выше.
.PP
Дополнительно поддерживаются все ioctl, документированные в
.BR ip (7)
и
.BR socket (7).

.SH КОДЫ ОШИБОК
Все коды ошибок, описанные в 
.BR socket (7)
или 
.BR ip (7),
могут быть получены при посылке или приеме на сокете UDP. 

.B ECONNREFUSED
С адресом назначения не связан ни один получатель. Эта ошибка может 
быть вызвана предыдущим пакетом, посланным через этот сокет.

.SH ВЕРСИИ
Опция IP_RECVERR появилась только в Linux 2.2.

.SH АВТОРЫ
Эту страницу руководства написал Andi Kleen.

.SH СМОТРИ ТАКЖЕ
.BR ip (7),
.BR socket (7),
.BR raw (7).

RFC768, где описан UDP.
.br
RFC1122, где описаны требования к хосту.
.br
RFC1191, где описан процесс обнаружения MTU маршрута.
